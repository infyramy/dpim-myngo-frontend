import{b as P,r as m,v as U,c as j,o as B,m as E,a as f,e as d,f as s,g as a,h as p,t as C,w as o,u as r,F,k as z,p as I,q as M,l as u}from"./vendor-D6Gd-AmM.js";import{u as q,a as A}from"./admin-DxRhEtpx.js";import{a as D,c as N,k as L,ak as H,al as W,_ as V,e as Y,am as G}from"./ui-C-FEV6Jq.js";import"./deps-CXbEQKqm.js";import"./auth-DV8b8DmP.js";const J={key:0,class:"flex items-center justify-center py-12"},K={key:1,class:"space-y-6"},Q={class:"text-center space-y-2"},X={class:"text-sm text-muted-foreground"},Z={class:"font-medium"},ee={class:"space-y-3"},te={class:"flex justify-center"},se={key:0,class:"flex items-center justify-center"},ae={key:1},oe={class:"text-center pt-4 border-t"},re={key:0},ne={key:1},ie={class:"text-center"},le={class:"text-sm text-muted-foreground"},_e=P({__name:"verify-otp",setup(de){const i=E(),b=U(),l=q(),_=m(b.query.email||""),c=m([]),v=m(!1),y=m(!0),n=m(0),$=j(()=>{const t=Math.floor(n.value/60),e=n.value%60;return`${t}:${e.toString().padStart(2,"0")}`});B(async()=>{x();try{for(;!l.isInitialized;)await new Promise(t=>setTimeout(t,50));if(l.isAuthenticated){console.log("User already authenticated, redirecting to appropriate dashboard"),k();return}if(!_.value){await i.replace("/login"),f.error("Please enter your email first");return}y.value=!1}catch(t){console.error("Error during initialization:",t),y.value=!1}});function x(){n.value=60;const t=setInterval(()=>{n.value>0?n.value-=1:clearInterval(t)},1e3)}function k(){const t=l.getUser().user_type;switch(t){case"superadmin":i.push("/superadmin/dashboard");break;case"admin":i.push("/admin/dashboard");break;case"operator":i.push("/operator/dashboard");break;case"user":i.push("/user/dashboard");break;default:console.warn("Unknown user role:",t),l.logoutUser(),i.push("/login");break}}async function w(){const t=c.value.join("");if(t.length!==6){f.error("Please enter all 6 digits");return}try{v.value=!0;let e=await A().post("/auth/verify-otp",{email:_.value,otp:t});l.setUser(e.data),e.data.user.user_role==="operator"&&l.setOperatorStates(e.data.operator_states),setTimeout(()=>{f.success("Verification code verified");const h=b.query.redirect;h?i.push(h):k()},1e3)}catch(e){console.error("OTP verification error:",e),f.error(e.message||"Invalid verification code"),v.value=!1}}async function S(){if(!(n.value>0))try{await l.sendOtp(_.value),f.success("Verification code resent"),x()}catch(t){console.error("Failed to resend OTP:",t),f.error(t.message||"Failed to resend verification code")}}function R(t){c.value=t,t.length===6&&t.every(e=>e.length===1)&&w()}function T(t){c.value=t}return(t,e)=>{const h=M("router-link");return y.value?(u(),d("div",J,e[1]||(e[1]=[s("div",{class:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"},null,-1)]))):(u(),d("div",K,[s("div",Q,[e[3]||(e[3]=s("h1",{class:"text-3xl font-bold tracking-tight"},"Verify Your Email",-1)),s("p",X,[e[2]||(e[2]=p(" Enter the 6-digit code sent to ")),s("span",Z,C(_.value),1)])]),a(r(Y),null,{default:o(()=>[a(r(D),{class:"space-y-1 pb-4"},{default:o(()=>e[4]||(e[4]=[s("h2",{class:"text-xl font-semibold text-center"}," Enter verification code ",-1)])),_:1,__:[4]}),a(r(N),{class:"space-y-6"},{default:o(()=>[s("form",{onSubmit:I(w,["prevent"]),class:"space-y-6"},[s("div",ee,[a(r(L),{class:"text-sm font-medium"},{default:o(()=>e[5]||(e[5]=[p("Verification Code")])),_:1,__:[5]}),s("div",te,[a(r(H),{modelValue:c.value,"onUpdate:modelValue":[e[0]||(e[0]=g=>c.value=g),T],length:6,type:"text",otp:"",class:"gap-3",onComplete:R},{default:o(()=>[a(r(W),null,{default:o(()=>[(u(),d(F,null,z(6,(g,O)=>a(r(G),{key:g,index:O,class:"h-12 w-12 text-lg font-medium bg-background"},null,8,["index"])),64))]),_:1})]),_:1},8,["modelValue"])])]),a(r(V),{type:"submit",class:"w-full h-11 font-medium",disabled:v.value||c.value.join("").length!==6},{default:o(()=>[v.value?(u(),d("span",se,e[6]||(e[6]=[s("svg",{class:"animate-spin mr-2 h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),p(" Verifying... ")]))):(u(),d("span",ae,"Verify & Continue"))]),_:1},8,["disabled"])],32),s("div",oe,[e[7]||(e[7]=s("p",{class:"text-sm text-muted-foreground mb-3"}," Didn't receive a code? ",-1)),a(r(V),{type:"button",variant:"ghost",class:"h-10 font-medium",disabled:n.value>0,onClick:S},{default:o(()=>[n.value>0?(u(),d("span",re," Resend in "+C($.value),1)):(u(),d("span",ne," Resend code "))]),_:1},8,["disabled"])])]),_:1})]),_:1}),s("div",ie,[s("p",le,[e[9]||(e[9]=p(" Want to use a different email? ")),a(h,{to:"/login",class:"font-medium text-primary hover:text-primary/90 underline underline-offset-4"},{default:o(()=>e[8]||(e[8]=[p(" Back to login ")])),_:1,__:[8]})])])]))}}});export{_e as default};
